version: 2.1

jobs:
  test:
    parallelism: 4
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout

      - run:
          name: Install UV
          command: pip install uv

      - run:
          name: Create uv virtual environment
          command: uv venv

      - run:
          name: Set environment variables
          command: |
            echo "export PYTHONPATH=$(pwd)" >> $BASH_ENV
            echo "source .venv/bin/activate" >> $BASH_ENV

      - run:
          name: Install dependencies and testing tools
          command: |
            uv pip install -e ".[dev]"
            uv pip install nose2[coverage_plugin]
            uv pip install pytest pytest-cov pytest-xdist
            
      - run:
          name: Verify nose2 installation
          command: |
            # Use -h to verify nose2 is installed (instead of --version which isn't supported)
            nose2 -h | head -n 1
            echo "Nose2 configuration:"
            cat nose2.cfg

      - run:
          name: Run tests
          command: |
            mkdir -p test-results
            # Original pytest command (commented out but available as an alternative)
            # pytest --junitxml=test-results/junit.xml --cov=src --cov-report=xml --cov-report=html
            
            # Using nose2 as the primary testing framework as specified in the README
            nose2 --verbose --with-coverage

      - run:
          name: Generate coverage XML report
          command: coverage xml -o coverage.xml

      - run:
          name: Generate coverage HTML report
          command: coverage html -d coverage-html

      - run:
          name: List test-results directory
          command: ls -la test-results/

      - run:
          name: Validate nose2 test results
          command: |
            echo "Checking nose2 test results file..."
            if [ -f test-results/junit.xml ]; then
              echo "✅ nose2 test results file exists"
              grep -q "testsuite name=\"nose2-junit\"" test-results/junit.xml && echo "✅ File contains nose2 test results"
            else
              echo "❌ nose2 test results file is missing"
              exit 1
            fi

      - run:
          name: Change permissions on test-results
          command: chmod -R 755 test-results/

      - store_test_results:
          path: test-results/

      - store_artifacts:
          path: test-results/junit.xml
          destination: test-results

      - store_artifacts:
          path: coverage.xml
          destination: coverage-report

      - store_artifacts:
          path: coverage-html/
          destination: coverage-html

      - run:
          name: Create custom artifacts
          command: |
            mkdir -p /tmp/artifacts
            echo "This is a custom artifact file" > /tmp/artifacts/custom-artifact-1.txt
            echo "This is another custom artifact file" > /tmp/artifacts/custom-artifact-2.txt

      - store_artifacts:
          path: /tmp/artifacts
          destination: custom-artifacts

  code_quality:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout

      - run:
          name: Install UV
          command: pip install uv

      - run:
          name: Create uv virtual environment
          command: uv venv

      - run:
          name: Set environment variables
          command: |
            echo "export PYTHONPATH=$(pwd)" >> $BASH_ENV
            echo "source .venv/bin/activate" >> $BASH_ENV

      - run:
          name: Install dependencies and Black
          command: |
            uv pip install -e ".[dev]"
            uv pip install black

      - run:
          name: Run Black (code formatting)
          command: black src/ tests/

  dependency_scanning:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout

      - run:
          name: Install UV
          command: pip install uv

      - run:
          name: Create uv virtual environment
          command: uv venv

      - run:
          name: Set environment variables
          command: |
            echo "export PYTHONPATH=$(pwd)" >> $BASH_ENV
            echo "source .venv/bin/activate" >> $BASH_ENV

      - run:
          name: Install dependencies and Safety
          command: |
            uv pip install -e ".[dev]"
            uv pip install safety

      - run:
          name: Run Safety (dependency scanning)
          command: safety check --full-report

workflows:
  version: 2
  test_and_scan:
    jobs:
      - test
      - code_quality
      - dependency_scanning
